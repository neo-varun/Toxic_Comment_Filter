<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Toxic Comment Classifier</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f7f7f7; }
        .container { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px #ccc; max-width: 500px; margin: auto; }
        button { padding: 10px 20px; margin: 10px 0; font-size: 16px; border-radius: 5px; border: none; background: #007bff; color: #fff; cursor: pointer; }
        button:disabled { background: #aaa; }
        .metrics { margin-top: 20px; }
        .status { margin-top: 10px; color: #007bff; }
    </style>
</head>
<body>
<div class="container">
    <h2>Toxic Comment Classifier</h2>
    <button id="trainBtn">Train Model</button>
    <button id="metricsBtn">View Metrics</button>
    <button id="optimizeBtn">Optimize Model</button>
    <button id="compareBtn">Compare Models</button>
    <div class="status" id="status"></div>
    <div class="metrics" id="metrics"></div>
    <div class="metrics" id="compareTable"></div>

    <div style="margin-top: 30px;">
        <label for="modelSelect"><b>Select Model:</b></label>
        <select id="modelSelect">
            <option value="pytorch">PyTorch</option>
            <option value="onnx">ONNX</option>
        </select>
    </div>
    <div style="margin-top: 10px;">
        <label for="predictInput"><b>Enter Comment:</b></label><br>
        <textarea id="predictInput" rows="3" style="width: 100%;"></textarea>
    </div>
    <button id="predictBtn">Predict</button>
    <div class="status" id="predictStatus"></div>
    <div class="metrics" id="predictResult"></div>
</div>
<script>
    const trainBtn = document.getElementById('trainBtn');
    const metricsBtn = document.getElementById('metricsBtn');
    const optimizeBtn = document.getElementById('optimizeBtn');
    const compareBtn = document.getElementById('compareBtn');
    const statusDiv = document.getElementById('status');
    const metricsDiv = document.getElementById('metrics');
    const compareTable = document.getElementById('compareTable');

    trainBtn.onclick = function() {
        statusDiv.textContent = 'Starting training...';
        metricsDiv.textContent = '';
        trainBtn.disabled = true;
        fetch('/train', {method: 'POST'})
            .then(res => res.json())
            .then(data => {
                statusDiv.textContent = data.message;
                if (data.status === 'started') {
                    pollStatus();
                } else {
                    trainBtn.disabled = false;
                }
            });
    };

    function pollStatus() {
        fetch('/status')
            .then(res => res.json())
            .then(data => {
                statusDiv.textContent = data.message;
                if (data.running) {
                    setTimeout(pollStatus, 2000);
                } else {
                    trainBtn.disabled = false;
                }
            });
    }

    metricsBtn.onclick = function() {
        statusDiv.textContent = '';
        metricsDiv.textContent = 'Loading metrics...';
        fetch('/metrics')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    const m = data.metrics;
                    metricsDiv.innerHTML = `<b>Accuracy:</b> ${m.accuracy}<br>
                        <b>Precision:</b> ${m.precision}<br>
                        <b>Recall:</b> ${m.recall}<br>
                        <b>F1 Score:</b> ${m.f1_score}`;
                } else {
                    metricsDiv.textContent = data.message;
                }
            });
    };

    optimizeBtn.onclick = function() {
        statusDiv.textContent = 'Starting model optimization...';
        metricsDiv.textContent = '';
        optimizeBtn.disabled = true;
        fetch('/optimize', {method: 'POST'})
            .then(res => res.json())
            .then(data => {
                statusDiv.textContent = data.message;
                if (data.status === 'started') {
                    pollOptimizationStatus();
                } else {
                    optimizeBtn.disabled = false;
                }
            });
    };

    function pollOptimizationStatus() {
        fetch('/optimization_status')
            .then(res => res.json())
            .then(function(data) {
                if (data.running) {
                    statusDiv.textContent = data.message;
                    setTimeout(pollOptimizationStatus, 2000);
                } else {
                    optimizeBtn.disabled = false;
                    if (data.result) {
                        statusDiv.textContent = '';
                        metricsDiv.innerHTML = '<b>Model optimization completed successfully.</b>';
                    }
                }
            });
    }

    const predictBtn = document.getElementById('predictBtn');
    const predictInput = document.getElementById('predictInput');
    const modelSelect = document.getElementById('modelSelect');
    const predictStatus = document.getElementById('predictStatus');
    const predictResult = document.getElementById('predictResult');

    predictBtn.onclick = function() {
        const text = predictInput.value.trim();
        const model = modelSelect.value;
        if (!text) {
            predictStatus.textContent = 'Please enter a comment.';
            return;
        }
        predictStatus.textContent = 'Predicting...';
        predictResult.textContent = '';
        predictBtn.disabled = true;
        fetch('/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, model })
        })
        .then(res => res.json())
        .then(data => {
            predictStatus.textContent = data.message || '';
            if (data.status === 'ok') {
                let html = '';
                for (const [label, prob] of Object.entries(data.prediction)) {
                    html += `<b>${label}:</b> ${prob}<br>`;
                }
                predictResult.innerHTML = html;
            } else {
                predictResult.textContent = data.error || data.message;
            }
            predictBtn.disabled = false;
        })
        .catch(() => {
            predictStatus.textContent = 'Prediction failed.';
            predictBtn.disabled = false;
        });
    };

    compareBtn.onclick = function() {
        compareBtn.disabled = true;
        compareTable.innerHTML = 'Comparing models...';
        fetch('/compare_models')
            .then(res => res.json())
            .then(data => {
                compareBtn.disabled = false;
                if (data.status === 'ok') {
                    const rows = data.results.map(row =>
                        `<tr><td>${row.model}</td><td>${row.size_mb}</td><td>${row.inference_ms}</td></tr>`
                    ).join('');
                    compareTable.innerHTML = `<table border="1" style="width:100%;margin-top:10px;text-align:center;">
                        <tr><th>Model</th><th>Size (MB)</th><th>Avg Inference Time (ms)</th></tr>
                        ${rows}
                    </table>`;
                } else {
                    compareTable.textContent = data.message;
                }
            })
            .catch(() => {
                compareBtn.disabled = false;
                compareTable.textContent = 'Comparison failed.';
            });
    };
</script>
</body>
</html>
